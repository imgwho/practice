<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>waterfall</title>
  <style>
    html {
      background-color: rgba(0, 0, 0, .2)
    }

    .images {
      position: relative;
      margin: 0 5%;
      width: 90%;
    }

    .images>img {
      border-radius: 4px;
      box-shadow: 0 0 6px 2px rgba(0, 0, 0, .5);
      position: absolute;
      border: 1px solid #ffffff;
    }

    .images>img:hover {
      transform: scale(2);
      z-index: 999;
      transition: all 2s;
    }

    .loading {
      text-align: center;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      line-height: 50px;
      color: #ffffff;
      background-color: rgba(0, 0, 0, .5);
      margin: 0;
    }
  </style>
</head>

<body>
  <div class="images"></div>
  <p class="loading" style="display: none">加载中 ...</p>
  <script>
    var obj, index, IMG_WIDTH

    window.onload = function () {
      initialArgs()
      getImages(50, index++)
    }

    window.onresize = function () {
      initialArgs()
      getImages(50, index++)
    }

    function initialArgs() {
      var parent = document.querySelector('.images')
      if (parent.offsetWidth < 880) {
        IMG_WIDTH = ((parent.offsetWidth - 40) / 3) | 0
        obj = {
          'index0': 0,
          'index1': 0,
          'index2': 0
        }
        parent.innerHTML = ''
        index = 0
      } else if (parent.offsetWidth < 1280) {
        IMG_WIDTH = ((parent.offsetWidth - 60) / 4) | 0
        obj = {
          'index0': 0,
          'index1': 0,
          'index2': 0,
          'index3': 0
        }
        parent.innerHTML = ''
        index = 0
      } else {
        IMG_WIDTH = ((parent.offsetWidth - 80) / 5) | 0
        obj = {
          'index0': 0,
          'index1': 0,
          'index2': 0,
          'index3': 0,
          'index4': 0
        }
        parent.innerHTML = ''
        index = 0
      }
    }

    window.onscroll = function () {
      var doc = document.documentElement
      var position = doc.clientHeight + doc.scrollTop
      if (position >= Math.min.apply(null, Object.values(obj))) {
        getImages(20, index++)
      }
    }

    function getImages(number, index) {
      var url = `https://gank.io/api/data/福利/${number}/${index}`
      var loading = document.querySelector('.loading')
      loading.style.display = 'block'
      fetch(url).then(res => res.json()).then(res => {
        loading.style.display = 'none'
        res.results.map(info => {
          renderImage(info.url, appendImg)
        })
      })
    }

    function renderImage(url, callback) {
      var img = new Image()
      img.src = url
      img.onload = function () {
        callback && callback({
          width: img.width,
          height: img.height
        }, img)
      }
    }

    function appendImg(info, target) {
      console.log(obj, IMG_WIDTH)
      var images = document.querySelector('.images')
      var len = document.querySelectorAll('.images > img').length
      var minNumber = Math.min.apply(null, Object.values(obj))
      var index = Object.values(obj).indexOf(minNumber)
      target.style.width = IMG_WIDTH + 'px'
      target.style.left = index * (IMG_WIDTH + 20) + 'px'
      target.style.top = `${Math.min.apply(null, Object.values(obj))}px`
      obj[`index${index}`] = obj[`index${index}`] + (IMG_WIDTH * (info.height / info.width)) + 20
      images.appendChild(target)
    }
  </script>
</body>

</html>